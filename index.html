<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Glean Procurement Intelligence Platform</title>
  <script defer src="/_vercel/insights/script.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7.23.9/babel.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'DM Sans', sans-serif; background: #F3F4F6; color: #111827; }
    @keyframes fadeSlideIn { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
    @keyframes shimmer { 0%{background-position:-200% 0} 100%{background-position:200% 0} }
    @keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
    @keyframes agentStep { from{opacity:0;transform:translateX(-8px)} to{opacity:1;transform:translateX(0)} }
    @keyframes dotBounce { 0%,80%,100%{transform:scale(0)} 40%{transform:scale(1)} }
    .fade-in { animation: fadeSlideIn 0.35s ease both; }
    .pulse-dot { animation: pulse 2s infinite; }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">

// ─── DATA ──────────────────────────────────────────────────────────────────

const suppliers = [
  { id: 1, name: "ThermoFlow Systems", category: "HVAC", quality: 87, delivery: 92, cost: 78, risk: "Low", spend: 2400000, defectRate: 1.2, onTime: 94, leadTime: 14, financial: "Stable", certs: ["ISO 9001", "IATF 16949"], location: "Charlotte, NC", incumbent: true },
  { id: 2, name: "MidSouth Components", category: "HVAC", quality: 81, delivery: 88, cost: 84, risk: "Medium", spend: 0, defectRate: 2.1, onTime: 89, leadTime: 18, financial: "Stable", certs: ["ISO 9001"], location: "Atlanta, GA", incumbent: false },
  { id: 3, name: "Allied Fastener Co.", category: "Fasteners", quality: 79, delivery: 85, cost: 71, risk: "Low", spend: 890000, defectRate: 1.8, onTime: 87, leadTime: 10, financial: "Stable", certs: ["ISO 9001"], location: "Memphis, TN", incumbent: true },
  { id: 4, name: "Guangzhou Precision", category: "Electronics", quality: 91, delivery: 74, cost: 94, risk: "High", spend: 1200000, defectRate: 0.9, onTime: 76, leadTime: 28, financial: "Flagged", certs: ["ISO 9001", "ISO 14001"], location: "Guangzhou, CN", incumbent: true },
  { id: 5, name: "SteelCore Industries", category: "Steel", quality: 84, delivery: 90, cost: 82, risk: "Low", spend: 1750000, defectRate: 1.4, onTime: 91, leadTime: 12, financial: "Stable", certs: ["ISO 9001", "ISO 14001", "IATF 16949"], location: "Pittsburgh, PA", incumbent: true },
];

const skus = [
  { id: "SKU-4421", name: "Cabin HVAC Module", supplier: "ThermoFlow Systems", annualSpend: 2400000, warrantySpend: 142000, defectRate: 1.2, volume: 18000 },
  { id: "SKU-2210", name: "Main Wiring Harness", supplier: "Guangzhou Precision", annualSpend: 1200000, warrantySpend: 98000, defectRate: 2.4, volume: 24000 },
  { id: "SKU-7703", name: "Front Door Panel", supplier: "SteelCore Industries", annualSpend: 890000, warrantySpend: 34000, defectRate: 0.9, volume: 32000 },
  { id: "SKU-1105", name: "Hex Bolt M8x25", supplier: "Allied Fastener Co.", annualSpend: 890000, warrantySpend: 22000, defectRate: 0.6, volume: 480000 },
  { id: "SKU-3302", name: "HVAC Bracket", supplier: "ThermoFlow Systems", annualSpend: 340000, warrantySpend: 18000, defectRate: 1.5, volume: 22000 },
  { id: "SKU-8801", name: "Control Module PCB", supplier: "Guangzhou Precision", annualSpend: 680000, warrantySpend: 56000, defectRate: 3.1, volume: 15000 },
  { id: "SKU-5514", name: "Steel Stamping A-Frame", supplier: "SteelCore Industries", annualSpend: 860000, warrantySpend: 29000, defectRate: 1.1, volume: 28000 },
];

const opportunities = [
  { id: 1, title: "Copper Price Drop: HVAC Renegotiation", classification: "Commodity Changes", status: "Investigating", impact: 445000, urgency: "High", description: "LME copper down 8.3% over 90 days. ThermoFlow contract uses market-indexed pricing. Window open to lock in fixed rate.", commodity: "Copper", currentPrice: 3.82, price3m: 4.17, price6m: 4.38, currentMaterialCost: 127, benchmarkCost: 116, unitSavings: 11, parts: ["SKU-4421", "SKU-3302"], tcoBreakdown: { unitPrice: 127, quality: 18, logistics: 8, inventory: 12, admin: 4, total: 169, benchmark: 148 } },
  { id: 2, title: "HRS Steel Deflation: Stamping Renegotiation", classification: "Commodity Changes", status: "Viewed", impact: 287000, urgency: "Medium", description: "Hot-rolled steel down 12% YTD. SteelCore contract renewal in 60 days. Leverage current benchmark vs contract rate.", commodity: "Steel (HRS)", currentPrice: 680, price3m: 720, price6m: 774, currentMaterialCost: 89, benchmarkCost: 78, unitSavings: 11, parts: ["SKU-7703", "SKU-5514"], tcoBreakdown: { unitPrice: 89, quality: 12, logistics: 6, inventory: 8, admin: 3, total: 118, benchmark: 102 } },
  { id: 3, title: "Wire Rod Decline: Fastener Repricing", classification: "Commodity Changes", status: "Under progress", impact: 156000, urgency: "Medium", description: "Wire rod index down 6.1%. Allied Fastener contract has quarterly repricing clause. Submit repricing request before Q2 close.", commodity: "Wire Rod", currentPrice: 620, price3m: 648, price6m: 660, currentMaterialCost: 42, benchmarkCost: 39, unitSavings: 3, parts: ["SKU-1105"], tcoBreakdown: { unitPrice: 42, quality: 8, logistics: 4, inventory: 5, admin: 2, total: 61, benchmark: 54 } },
  { id: 4, title: "ThermoFlow HVAC Contract Expiry", classification: "Contract Renewals", status: "Viewed", impact: 280000, urgency: "High", description: "ThermoFlow contract expires in 89 days. $2.4M annual spend at risk. Begin RFP to create competitive tension.", parts: ["SKU-4421", "SKU-3302"] },
  { id: 5, title: "Allied Fastener Annual Renewal", classification: "Contract Renewals", status: "Investigating", impact: 95000, urgency: "Medium", description: "Allied Fastener auto-renews in 120 days. Historical 3% annual price increase. Volume commitments can offset.", parts: ["SKU-1105"] },
  { id: 6, title: "Section 301 Tariff Mitigation: Electronics", classification: "Supply Chain Risks", status: "Viewed", impact: 340000, urgency: "High", description: "25% Section 301 tariff on electronics imports from China. Guangzhou Precision sourcing at risk. Qualify domestic alternatives.", parts: ["SKU-2210", "SKU-8801"] },
  { id: 7, title: "Guangzhou Precision: Financial Health Decline", classification: "Supply Chain Risks", status: "Investigating", impact: 180000, urgency: "High", description: "D&B score dropped from 72 to 58. Missed 3 consecutive delivery targets. Begin dual-source qualification.", parts: ["SKU-2210", "SKU-8801"] },
  { id: 8, title: "HSLA Grade Substitution: HVAC Brackets", classification: "VAVE", status: "Completed", impact: 62000, urgency: "Low", description: "Engineering approved HSLA 340 substitution for HSLA 420 on bracket assembly. Lower cost spec, same performance.", parts: ["SKU-3302"] },
  { id: 9, title: "Fastener Spec Consolidation", classification: "VAVE", status: "Under progress", impact: 78000, urgency: "Low", description: "Consolidate 14 fastener SKUs to 6. Reduce tail-spend complexity, improve volume leverage with Allied.", parts: ["SKU-1105"] },
];

const costModels = [
  { id: "SKU-4421", name: "Cabin HVAC Module", supplier: "ThermoFlow Systems", currentCost: 127, zbbTarget: 108, annualVolume: 18000, breakdown: { rawMaterials: { copper: {cost:38,benchmark:35}, aluminum: {cost:22,benchmark:20}, plastics: {cost:12,benchmark:11} }, labor: {cost:18,benchmark:15}, overhead: {cost:14,benchmark:12}, logistics: {cost:8,benchmark:7}, margin: {cost:15,benchmark:8} }, tco: { unitPrice:127, quality:18, logistics:8, inventory:12, admin:4, total:169, benchmark:148, tariff:0 } },
  { id: "SKU-2210", name: "Main Wiring Harness", supplier: "Guangzhou Precision", currentCost: 89, zbbTarget: 74, annualVolume: 24000, breakdown: { rawMaterials: { copper: {cost:34,benchmark:31}, pvc: {cost:8,benchmark:7}, connectors: {cost:11,benchmark:9} }, labor: {cost:12,benchmark:10}, overhead: {cost:9,benchmark:8}, logistics: {cost:6,benchmark:5}, margin: {cost:9,benchmark:4} }, tco: { unitPrice:89, quality:24, logistics:6, inventory:8, admin:3, total:130, benchmark:108, tariff:22 } },
  { id: "SKU-7703", name: "Front Door Panel", supplier: "SteelCore Industries", currentCost: 62, zbbTarget: 54, annualVolume: 32000, breakdown: { rawMaterials: { hrs: {cost:28,benchmark:24}, coatings: {cost:6,benchmark:5}, hardware: {cost:4,benchmark:4} }, labor: {cost:10,benchmark:9}, overhead: {cost:8,benchmark:7}, logistics: {cost:3,benchmark:3}, margin: {cost:3,benchmark:2} }, tco: { unitPrice:62, quality:9, logistics:3, inventory:6, admin:2, total:82, benchmark:71, tariff:0 } },
];

const defaultTriggers = [
  { id: 1, name: "Commodity Price Drop", type: "Market", condition: "Price drops >5% over 30 days", action: "Create opportunity in Hopper", enabled: true, lastTriggered: "2 hours ago", count: 14 },
  { id: 2, name: "Contract Expiry Alert", type: "Contract", condition: "Contract expires in <90 days", action: "Flag for renewal review", enabled: true, lastTriggered: "3 days ago", count: 7 },
  { id: 3, name: "Supplier Financial Health", type: "Risk", condition: "D&B score drops >10 points", action: "Escalate to supply risk team", enabled: true, lastTriggered: "1 week ago", count: 3 },
  { id: 4, name: "Section 301 Tariff Impact", type: "Regulatory", condition: "New tariff affects active supplier", action: "Create mitigation opportunity", enabled: true, lastTriggered: "5 days ago", count: 8 },
  { id: 5, name: "Quality Defect Threshold", type: "Quality", condition: "Defect rate exceeds 2.0%", action: "Create warranty cost alert", enabled: false, lastTriggered: "2 weeks ago", count: 5 },
  { id: 6, name: "Engineering Spec Change", type: "Engineering", condition: "BOM change affects active PO", action: "Alert category manager", enabled: true, lastTriggered: "4 days ago", count: 11 },
];

const impactData = {
  pipeline: { identified: 2960000, inProgress: 1820000, verified: 920000 },
  quarterly: [
    { quarter: "Q3 2025", identified: 1840000, verified: 580000 },
    { quarter: "Q4 2025", identified: 2310000, verified: 740000 },
    { quarter: "Q1 2026", identified: 2960000, verified: 920000 },
  ],
  byCategory: [
    { category: "HVAC", identified: 980000, verified: 380000, color: "#4F46E5" },
    { category: "Electronics", identified: 720000, verified: 220000, color: "#059669" },
    { category: "Steel", identified: 560000, verified: 180000, color: "#D97706" },
    { category: "Fasteners", identified: 380000, verified: 140000, color: "#DC2626" },
    { category: "Other", identified: 320000, verified: 0, color: "#6B7280" },
  ],
  verifiedItems: [
    { action: "Copper renegotiation: ThermoFlow Q3", amount: 218000, date: "Oct 2025", category: "HVAC", type: "Commodity" },
    { action: "HSLA spec substitution: Brackets", amount: 62000, date: "Nov 2025", category: "HVAC", type: "VAVE" },
    { action: "HRS steel: SteelCore repricing", amount: 187000, date: "Nov 2025", category: "Steel", type: "Commodity" },
    { action: "Wiring harness ZBB renegotiation", amount: 142000, date: "Dec 2025", category: "Electronics", type: "ZBB" },
    { action: "Allied Fastener volume consolidation", amount: 78000, date: "Jan 2026", category: "Fasteners", type: "VAVE" },
    { action: "Guangzhou dual-source qualification", amount: 110000, date: "Jan 2026", category: "Electronics", type: "Risk" },
    { action: "HVAC module TCO benchmark", amount: 123000, date: "Feb 2026", category: "HVAC", type: "ZBB" },
  ],
};

const briefings = [
  { id: 1, priority: "high", title: "Copper dropped 2.1% overnight", detail: "LME copper now at $3.82/lb. Your HVAC opportunity impact increased to $445K.", time: "6:14 AM", action: "View Opportunity", tab: "hopper", oppId: 1 },
  { id: 2, priority: "high", title: "Guangzhou missed 3rd consecutive delivery", detail: "On-time delivery now 71%. Financial health score declined to 54. Dual-source qualification urgent.", time: "7:02 AM", action: "View Risk", tab: "hopper", oppId: 7 },
  { id: 3, priority: "medium", title: "Allied Fastener contract 89 days out", detail: "Auto-renewal triggers Oct 15. Historical 3% increase = $26K. Begin RFP now to create leverage.", time: "7:30 AM", action: "View Contract", tab: "hopper", oppId: 5 },
  { id: 4, priority: "low", title: "Fastener spec consolidation approved", detail: "Engineering signed off on SKU consolidation from 14 to 6. Move to savings verification.", time: "8:45 AM", action: "Track Savings", tab: "impact" },
  { id: 5, priority: "medium", title: "Q1 impact tracking updated", detail: "$920K verified savings confirmed. On pace to hit $1.1M quarterly target.", time: "9:00 AM", action: "View Dashboard", tab: "impact" },
];

const AGENT_STEPS = [
  { label: "Planning approach", detail: "Agentic Engine analyzing query intent and routing to relevant data sources", source: "Agentic Engine", duration: 800 },
  { label: "Searching Enterprise Graph", detail: "Traversing 2.4M entity relationships: suppliers, contracts, spend records", source: "Enterprise Graph", duration: 1000 },
  { label: "Pulling supplier database", detail: "Retrieving HVAC supplier profiles, scores, certifications from ERP", source: "ERP + Quality System", duration: 900 },
  { label: "Running cost models", detail: "Computing TCO comparison: unit price + quality + logistics + inventory + admin", source: "Intelligence Engine", duration: 1100 },
  { label: "Generating insights", detail: "Synthesizing market intelligence, tariff exposure, risk signals", source: "Market Intelligence", duration: 700 },
];

const COMPLEX_QUERY_TRIGGERS = ["compare", "alternative", "vs", "versus", "benchmark", "find me", "southeast", "all hvac", "tco"];

// ─── HELPERS ─────────────────────────────────────────────────────────────────

const fmt = (n) => n >= 1000000 ? `$${(n/1000000).toFixed(1)}M` : n >= 1000 ? `$${Math.round(n/1000)}K` : `$${n}`;
const pct = (a, b) => `${(((a-b)/b)*100).toFixed(1)}%`;

// ─── DESIGN TOKENS ───────────────────────────────────────────────────────────

const C = {
  indigo: "#4F46E5", indigoBg: "#EEF2FF", indigoLight: "#6366F1",
  green: "#059669", greenBg: "#ECFDF5",
  amber: "#D97706", amberBg: "#FFFBEB",
  red: "#DC2626", redBg: "#FEF2F2",
  gray: "#6B7280", border: "#E5E7EB", bg: "#F3F4F6",
  white: "#FFFFFF", dark: "#111827", mid: "#374151",
};

const card = { background: C.white, border: `1px solid ${C.border}`, borderRadius: 12, padding: 20 };
const smallCard = { ...card, padding: 16 };
const badge = (color, bg) => ({ background: bg, color: color, borderRadius: 20, padding: "2px 10px", fontSize: 12, fontWeight: 600, display: "inline-block" });

// ─── REUSABLE COMPONENTS ─────────────────────────────────────────────────────

const ScoreBar = ({ value, color }) => (
  <div style={{ display:"flex", alignItems:"center", gap:8 }}>
    <div style={{ flex:1, height:6, background:"#F3F4F6", borderRadius:6, overflow:"hidden" }}>
      <div style={{ width:`${value}%`, height:"100%", background: color || C.indigo, borderRadius:6, transition:"width 0.6s ease" }} />
    </div>
    <span style={{ fontSize:12, fontWeight:600, color:C.dark, minWidth:28 }}>{value}</span>
  </div>
);

const PriorityDot = ({ priority }) => {
  const colors = { high: C.red, medium: C.amber, low: C.green };
  return <div style={{ width:8, height:8, borderRadius:"50%", background: colors[priority] || C.gray, flexShrink:0 }} />;
};

const SourcePill = ({ label, color }) => (
  <span style={{ background: color || C.indigoBg, color: C.indigo, borderRadius:20, padding:"2px 10px", fontSize:11, fontWeight:600, border:`1px solid ${C.border}` }}>{label}</span>
);

// ─── DATA SOURCE VISUALIZATION ───────────────────────────────────────────────

const DataSourceViz = ({ sources }) => {
  const sourceColors = {
    "Enterprise Graph": C.indigo,
    "ERP": C.green,
    "Quality System": C.amber,
    "Contract CLM": "#7C3AED",
    "Market Feed": C.red,
    "D&B": "#0891B2",
  };
  return (
    <div style={{ display:"flex", flexWrap:"wrap", gap:8, marginTop:8 }}>
      {sources.map((s, i) => (
        <div key={s} className="fade-in" style={{ animationDelay:`${i*80}ms`, display:"flex", alignItems:"center", gap:6, background:C.white, border:`1px solid ${C.border}`, borderRadius:20, padding:"4px 12px" }}>
          <div style={{ width:7, height:7, borderRadius:"50%", background: sourceColors[s] || C.gray, animation:"pulse 2s infinite", animationDelay:`${i*300}ms` }} />
          <span style={{ fontSize:12, fontWeight:500, color:C.mid }}>{s}</span>
        </div>
      ))}
    </div>
  );
};

// ─── AGENT THINKING ──────────────────────────────────────────────────────────

const AgentThinking = ({ onComplete }) => {
  const [steps, setSteps] = React.useState([]);
  const [done, setDone] = React.useState(false);

  React.useEffect(() => {
    let idx = 0;
    const run = () => {
      if (idx >= AGENT_STEPS.length) { setTimeout(() => { setDone(true); onComplete(); }, 400); return; }
      const step = AGENT_STEPS[idx];
      setSteps(prev => [...prev, { ...step, complete: false }]);
      setTimeout(() => {
        setSteps(prev => prev.map((s, i) => i === idx ? { ...s, complete: true } : s));
        idx++;
        setTimeout(run, 200);
      }, step.duration);
    };
    setTimeout(run, 200);
  }, []);

  return (
    <div style={{ ...smallCard, marginBottom:16, borderLeft:`3px solid ${C.indigo}` }}>
      <div style={{ display:"flex", alignItems:"center", gap:10, marginBottom:14 }}>
        <div style={{ width:28, height:28, borderRadius:8, background:C.indigoBg, display:"flex", alignItems:"center", justifyContent:"center" }}>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke={C.indigo} strokeWidth="2.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
        </div>
        <div>
          <div style={{ fontSize:13, fontWeight:700, color:C.dark }}>Agentic Engine Running</div>
          <div style={{ fontSize:11, color:C.gray }}>Multi-step reasoning across your enterprise data</div>
        </div>
        {done && <span style={{ marginLeft:"auto", ...badge(C.green, C.greenBg) }}>Complete</span>}
      </div>
      <div style={{ display:"flex", flexDirection:"column", gap:8 }}>
        {steps.map((step, i) => (
          <div key={i} className="fade-in" style={{ display:"flex", alignItems:"flex-start", gap:10, animation:"agentStep 0.3s ease both" }}>
            <div style={{ marginTop:2, width:18, height:18, borderRadius:"50%", border:`2px solid ${step.complete ? C.green : C.indigo}`, background: step.complete ? C.greenBg : C.indigoBg, display:"flex", alignItems:"center", justifyContent:"center", flexShrink:0, transition:"all 0.3s" }}>
              {step.complete
                ? <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke={C.green} strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>
                : <div style={{ width:6, height:6, borderRadius:"50%", background:C.indigo, animation:"pulse 1s infinite" }} />
              }
            </div>
            <div style={{ flex:1 }}>
              <div style={{ display:"flex", alignItems:"center", gap:8 }}>
                <span style={{ fontSize:12, fontWeight:600, color:C.dark }}>{step.label}</span>
                <span style={{ fontSize:11, color:C.indigo, background:C.indigoBg, padding:"1px 7px", borderRadius:10 }}>{step.source}</span>
              </div>
              <div style={{ fontSize:11, color:C.gray, marginTop:2 }}>{step.detail}</div>
            </div>
          </div>
        ))}
        {!done && steps.length > 0 && (
          <div style={{ display:"flex", gap:4, paddingLeft:28, paddingTop:2 }}>
            {[0,1,2].map(i => <div key={i} style={{ width:6, height:6, borderRadius:"50%", background:C.indigo, animation:`dotBounce 1.2s ${i*0.2}s infinite` }} />)}
          </div>
        )}
      </div>
    </div>
  );
};

// ─── SUPPLIER COMPARISON ──────────────────────────────────────────────────────

const SupplierCompare = ({ suppliers }) => {
  const metrics = [
    { key:"quality", label:"Quality Score", unit:"", higher:true },
    { key:"delivery", label:"Delivery Score", unit:"", higher:true },
    { key:"cost", label:"Cost Score", unit:"", higher:false },
    { key:"defectRate", label:"Defect Rate", unit:"%", higher:false },
    { key:"onTime", label:"On-Time Delivery", unit:"%", higher:true },
    { key:"leadTime", label:"Lead Time", unit:" days", higher:false },
  ];
  const winner = (metric, vals) => {
    const best = metric.higher ? Math.max(...vals) : Math.min(...vals);
    return vals.indexOf(best);
  };
  return (
    <div style={{ ...card, marginBottom:16 }}>
      <div style={{ display:"flex", alignItems:"center", justifyContent:"space-between", marginBottom:16 }}>
        <div style={{ fontSize:14, fontWeight:700, color:C.dark }}>Supplier Comparison</div>
        <span style={{ fontSize:11, color:C.gray }}>Green = best value</span>
      </div>
      <div style={{ overflowX:"auto" }}>
        <table style={{ width:"100%", borderCollapse:"collapse", fontSize:13 }}>
          <thead>
            <tr>
              <th style={{ textAlign:"left", padding:"8px 12px", fontWeight:600, color:C.gray, borderBottom:`1px solid ${C.border}`, fontSize:12 }}>Metric</th>
              {suppliers.map(s => (
                <th key={s.id} style={{ textAlign:"center", padding:"8px 12px", fontWeight:600, color:C.dark, borderBottom:`1px solid ${C.border}`, fontSize:12 }}>
                  <div>{s.name}</div>
                  {!s.incumbent && <span style={{ ...badge(C.indigo, C.indigoBg), marginTop:4 }}>Alternative</span>}
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {metrics.map(metric => {
              const vals = suppliers.map(s => s[metric.key]);
              const wi = winner(metric, vals);
              return (
                <tr key={metric.key}>
                  <td style={{ padding:"8px 12px", color:C.gray, fontSize:12, borderBottom:`1px solid ${C.border}` }}>{metric.label}</td>
                  {vals.map((v, i) => (
                    <td key={i} style={{ padding:"8px 12px", textAlign:"center", borderBottom:`1px solid ${C.border}`, background: i === wi ? C.greenBg : "transparent", color: i === wi ? C.green : C.dark, fontWeight: i === wi ? 700 : 400 }}>
                      {v}{metric.unit} {i === wi && <span style={{ fontSize:11 }}>✓</span>}
                    </td>
                  ))}
                </tr>
              );
            })}
            <tr>
              <td style={{ padding:"8px 12px", color:C.gray, fontSize:12 }}>Financial Health</td>
              {suppliers.map(s => (
                <td key={s.id} style={{ padding:"8px 12px", textAlign:"center" }}>
                  <span style={{ ...badge(s.financial === "Stable" ? C.green : C.red, s.financial === "Stable" ? C.greenBg : C.redBg) }}>{s.financial}</span>
                </td>
              ))}
            </tr>
            <tr>
              <td style={{ padding:"8px 12px", color:C.gray, fontSize:12 }}>Location</td>
              {suppliers.map(s => <td key={s.id} style={{ padding:"8px 12px", textAlign:"center", fontSize:12, color:C.mid }}>{s.location}</td>)}
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  );
};

// ─── MORNING BRIEFING ─────────────────────────────────────────────────────────

const MorningBriefing = ({ onNavigate }) => {
  const [expanded, setExpanded] = React.useState(true);
  const priorityStyle = { high: { dot: C.red, bg: "#FFF5F5" }, medium: { dot: C.amber, bg: "#FFFBEB" }, low: { dot: C.green, bg: "#F0FDF4" } };
  return (
    <div style={{ ...card, marginBottom:20, borderLeft:`3px solid ${C.indigo}` }} className="fade-in">
      <div style={{ display:"flex", alignItems:"center", justifyContent:"space-between", cursor:"pointer" }} onClick={() => setExpanded(!expanded)}>
        <div style={{ display:"flex", alignItems:"center", gap:10 }}>
          <div style={{ width:32, height:32, borderRadius:10, background:C.indigoBg, display:"flex", alignItems:"center", justifyContent:"center" }}>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke={C.indigo} strokeWidth="2.5"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
          </div>
          <div>
            <div style={{ fontSize:14, fontWeight:700, color:C.dark }}>Today's Briefing</div>
            <div style={{ fontSize:12, color:C.gray }}>February 18, 2026 · {briefings.filter(b=>b.priority==="high").length} urgent items</div>
          </div>
        </div>
        <div style={{ display:"flex", alignItems:"center", gap:8 }}>
          {briefings.filter(b => b.priority === "high").length > 0 && (
            <span style={{ ...badge(C.red, C.redBg) }}>{briefings.filter(b=>b.priority==="high").length} High</span>
          )}
          <span style={{ color:C.gray, fontSize:12 }}>{expanded ? "▲" : "▼"}</span>
        </div>
      </div>
      {expanded && (
        <div style={{ marginTop:14, display:"flex", flexDirection:"column", gap:8 }}>
          {briefings.map((b, i) => (
            <div key={b.id} className="fade-in" style={{ animationDelay:`${i*60}ms`, display:"flex", alignItems:"flex-start", gap:10, padding:12, background: priorityStyle[b.priority].bg, borderRadius:8, border:`1px solid ${C.border}` }}>
              <PriorityDot priority={b.priority} />
              <div style={{ flex:1 }}>
                <div style={{ display:"flex", alignItems:"center", gap:8, marginBottom:2 }}>
                  <span style={{ fontSize:13, fontWeight:600, color:C.dark }}>{b.title}</span>
                  <span style={{ fontSize:11, color:C.gray }}>{b.time}</span>
                </div>
                <div style={{ fontSize:12, color:C.mid }}>{b.detail}</div>
              </div>
              <button onClick={() => onNavigate(b)} style={{ flexShrink:0, background:C.indigo, color:C.white, border:"none", borderRadius:8, padding:"5px 12px", fontSize:11, fontWeight:600, cursor:"pointer", whiteSpace:"nowrap" }}>
                {b.action}
              </button>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

// ─── IMPACT INTELLIGENCE DASHBOARD ───────────────────────────────────────────

const ImpactDashboard = () => {
  const [view, setView] = React.useState("individual");
  const { pipeline, quarterly, byCategory, verifiedItems } = impactData;

  const viewMultipliers = { individual: 1, director: 4.2, csuite: 18.7 };
  const mult = viewMultipliers[view];
  const scaleFmt = (n) => fmt(Math.round(n * mult));

  const WaterfallBar = ({ label, value, max, color, sublabel }) => {
    const pctW = Math.max(10, (value/max)*100);
    return (
      <div style={{ flex:1 }}>
        <div style={{ fontSize:12, color:C.gray, marginBottom:6, fontWeight:500 }}>{label}</div>
        <div style={{ height:48, background:`${color}18`, borderRadius:8, overflow:"hidden", position:"relative", border:`1px solid ${color}40` }}>
          <div style={{ width:`${pctW}%`, height:"100%", background:color, borderRadius:8, transition:"width 0.8s ease", display:"flex", alignItems:"center", justifyContent:"flex-end", paddingRight:10 }}>
            <span style={{ fontSize:13, fontWeight:800, color:C.white }}>{scaleFmt(value)}</span>
          </div>
        </div>
        {sublabel && <div style={{ fontSize:11, color:C.gray, marginTop:4 }}>{sublabel}</div>}
      </div>
    );
  };

  return (
    <div className="fade-in">
      {/* Header */}
      <div style={{ marginBottom:20 }}>
        <div style={{ display:"flex", alignItems:"center", justifyContent:"space-between", marginBottom:12 }}>
          <div>
            <div style={{ fontSize:18, fontWeight:800, color:C.dark }}>Impact Intelligence</div>
            <div style={{ fontSize:13, color:C.gray, marginTop:2 }}>Savings tracked from identification to verified financial impact</div>
          </div>
          <div style={{ display:"flex", gap:4, background:C.bg, borderRadius:10, padding:4 }}>
            {["individual","director","csuite"].map(v => (
              <button key={v} onClick={() => setView(v)} style={{ padding:"6px 14px", borderRadius:8, border:"none", fontSize:12, fontWeight:600, cursor:"pointer", background: view===v ? C.indigo : "transparent", color: view===v ? C.white : C.gray, transition:"all 0.2s" }}>
                {v === "individual" ? "My View" : v === "director" ? "Director" : "C-Suite"}
              </button>
            ))}
          </div>
        </div>
      </div>

      {/* Pipeline Waterfall */}
      <div style={{ ...card, marginBottom:16 }}>
        <div style={{ fontSize:14, fontWeight:700, color:C.dark, marginBottom:16 }}>Savings Pipeline · Q1 2026</div>
        <div style={{ display:"flex", gap:12, alignItems:"stretch", marginBottom:12 }}>
          <WaterfallBar label="Identified" value={pipeline.identified} max={pipeline.identified} color={C.indigo} sublabel={`${Math.round(pipeline.inProgress/pipeline.identified*100)}% advancing`} />
          <div style={{ display:"flex", alignItems:"center", color:C.gray }}>→</div>
          <WaterfallBar label="In Progress" value={pipeline.inProgress} max={pipeline.identified} color={C.amber} sublabel={`${Math.round(pipeline.verified/pipeline.inProgress*100)}% converting`} />
          <div style={{ display:"flex", alignItems:"center", color:C.gray }}>→</div>
          <WaterfallBar label="Verified Savings" value={pipeline.verified} max={pipeline.identified} color={C.green} sublabel="Finance confirmed" />
        </div>
        <div style={{ display:"flex", gap:16, padding:"12px 0", borderTop:`1px solid ${C.border}` }}>
          {[
            { label:"Conversion Rate", value:`${Math.round(pipeline.verified/pipeline.identified*100)}%` },
            { label:"Avg Cycle Time", value:"47 days" },
            { label:"Active Opportunities", value:"7" },
            { label:"On Track for Target", value:"Yes" },
          ].map(m => (
            <div key={m.label} style={{ flex:1, textAlign:"center" }}>
              <div style={{ fontSize:20, fontWeight:800, color:C.dark }}>{m.value}</div>
              <div style={{ fontSize:11, color:C.gray }}>{m.label}</div>
            </div>
          ))}
        </div>
      </div>

      {/* Quarterly Trend */}
      <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:16, marginBottom:16 }}>
        <div style={{ ...card }}>
          <div style={{ fontSize:13, fontWeight:700, color:C.dark, marginBottom:14 }}>Quarterly Trend</div>
          <div style={{ display:"flex", flexDirection:"column", gap:10 }}>
            {quarterly.map(q => (
              <div key={q.quarter}>
                <div style={{ display:"flex", justifyContent:"space-between", marginBottom:4 }}>
                  <span style={{ fontSize:12, color:C.mid, fontWeight:500 }}>{q.quarter}</span>
                  <span style={{ fontSize:12, color:C.green, fontWeight:600 }}>{scaleFmt(q.verified)} verified</span>
                </div>
                <div style={{ height:8, background:C.bg, borderRadius:6, overflow:"hidden", position:"relative" }}>
                  <div style={{ position:"absolute", width:`${(q.identified/quarterly[2].identified)*100}%`, height:"100%", background:`${C.indigo}40`, borderRadius:6 }} />
                  <div style={{ position:"absolute", width:`${(q.verified/quarterly[2].identified)*100}%`, height:"100%", background:C.green, borderRadius:6 }} />
                </div>
              </div>
            ))}
          </div>
          <div style={{ display:"flex", gap:12, marginTop:12, fontSize:11, color:C.gray }}>
            <span style={{ display:"flex", alignItems:"center", gap:4 }}><div style={{ width:10, height:10, borderRadius:2, background:`${C.indigo}40` }} />Identified</span>
            <span style={{ display:"flex", alignItems:"center", gap:4 }}><div style={{ width:10, height:10, borderRadius:2, background:C.green }} />Verified</span>
          </div>
        </div>

        <div style={{ ...card }}>
          <div style={{ fontSize:13, fontWeight:700, color:C.dark, marginBottom:14 }}>By Category</div>
          <div style={{ display:"flex", flexDirection:"column", gap:10 }}>
            {byCategory.map(cat => (
              <div key={cat.category}>
                <div style={{ display:"flex", justifyContent:"space-between", marginBottom:4 }}>
                  <span style={{ fontSize:12, color:C.mid, fontWeight:500 }}>{cat.category}</span>
                  <span style={{ fontSize:12, fontWeight:600, color:C.dark }}>{scaleFmt(cat.identified)}</span>
                </div>
                <div style={{ height:6, background:C.bg, borderRadius:6, overflow:"hidden", position:"relative" }}>
                  <div style={{ position:"absolute", width:`${(cat.identified/byCategory[0].identified)*100}%`, height:"100%", background:`${cat.color}30`, borderRadius:6 }} />
                  <div style={{ position:"absolute", width:`${(cat.verified/byCategory[0].identified)*100}%`, height:"100%", background:cat.color, borderRadius:6 }} />
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* Verified Savings Table */}
      <div style={{ ...card }}>
        <div style={{ fontSize:13, fontWeight:700, color:C.dark, marginBottom:14 }}>Verified Savings Log</div>
        <table style={{ width:"100%", borderCollapse:"collapse", fontSize:13 }}>
          <thead>
            <tr>
              {["Action","Amount","Date","Category","Type"].map(h => (
                <th key={h} style={{ textAlign:"left", padding:"8px 12px", fontWeight:600, color:C.gray, borderBottom:`1px solid ${C.border}`, fontSize:11 }}>{h}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {verifiedItems.map((item, i) => (
              <tr key={i} className="fade-in" style={{ animationDelay:`${i*40}ms` }}>
                <td style={{ padding:"10px 12px", color:C.dark, fontWeight:500, borderBottom:`1px solid ${C.border}` }}>{item.action}</td>
                <td style={{ padding:"10px 12px", color:C.green, fontWeight:700, borderBottom:`1px solid ${C.border}` }}>{scaleFmt(item.amount)}</td>
                <td style={{ padding:"10px 12px", color:C.gray, borderBottom:`1px solid ${C.border}` }}>{item.date}</td>
                <td style={{ padding:"10px 12px", borderBottom:`1px solid ${C.border}` }}>
                  <span style={{ ...badge(C.indigo, C.indigoBg) }}>{item.category}</span>
                </td>
                <td style={{ padding:"10px 12px", borderBottom:`1px solid ${C.border}` }}>
                  <span style={{ ...badge(C.gray, C.bg) }}>{item.type}</span>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
        <div style={{ padding:"12px 12px 0", borderTop:`1px solid ${C.border}`, marginTop:4, display:"flex", justifyContent:"space-between", alignItems:"center" }}>
          <span style={{ fontSize:12, color:C.gray }}>Total verified this quarter</span>
          <span style={{ fontSize:18, fontWeight:800, color:C.green }}>{scaleFmt(verifiedItems.reduce((a,b) => a+b.amount, 0))}</span>
        </div>
      </div>
    </div>
  );
};

// ─── SEARCH PAGE ─────────────────────────────────────────────────────────────

const SUGGESTIONS_ROW1 = [
  "Compare HVAC suppliers Southeast",
  "Find alternative HVAC suppliers and compare TCO to ThermoFlow",
  "HVAC supplier quality scorecards",
];
const SUGGESTIONS_ROW2 = [
  "Warranty spend by supplier",
  "Upcoming contract expirations",
  "High-risk supplier exposure",
];

const processQuery = (q) => {
  const lower = q.toLowerCase();
  const isComplex = COMPLEX_QUERY_TRIGGERS.some(t => lower.includes(t));
  let results = [];
  let sources = [];

  if (lower.includes("supplier") || lower.includes("scorecard") || lower.includes("quality") || lower.includes("compare") || lower.includes("hvac") || lower.includes("alternative")) {
    results.push({ type: "suppliers", data: suppliers.filter(s => lower.includes("hvac") ? s.category === "HVAC" : true).slice(0, 3) });
    sources = ["Enterprise Graph", "ERP", "Quality System"];
  }
  if (lower.includes("warranty") || lower.includes("defect") || lower.includes("spend")) {
    results.push({ type: "warranty", data: skus.slice(0, 4) });
    sources = [...new Set([...sources, "ERP", "Quality System"])];
  }
  if (lower.includes("contract") || lower.includes("expir")) {
    results.push({ type: "contracts", data: opportunities.filter(o => o.classification === "Contract Renewals") });
    sources = [...new Set([...sources, "Contract CLM", "Enterprise Graph"])];
  }
  if (lower.includes("risk") || lower.includes("tariff") || lower.includes("guangzhou")) {
    results.push({ type: "risks", data: opportunities.filter(o => o.classification === "Supply Chain Risks") });
    sources = [...new Set([...sources, "D&B", "Market Feed", "Enterprise Graph"])];
  }
  if (lower.includes("opportunit") || lower.includes("saving") || lower.includes("commodity")) {
    results.push({ type: "opportunities", data: opportunities.slice(0, 4) });
    sources = [...new Set([...sources, "Market Feed", "Enterprise Graph", "ERP"])];
  }
  if (results.length === 0) {
    results.push({ type: "suppliers", data: suppliers.slice(0, 2) });
    sources = ["Enterprise Graph", "ERP"];
  }
  return { results, sources, isComplex };
};

const SearchPage = ({ onNavigate }) => {
  const [query, setQuery] = React.useState("");
  const [submitted, setSubmitted] = React.useState("");
  const [agentRunning, setAgentRunning] = React.useState(false);
  const [agentDone, setAgentDone] = React.useState(false);
  const [searchResult, setSearchResult] = React.useState(null);
  const [showCompare, setShowCompare] = React.useState(false);

  const handleSearch = (q) => {
    const text = q || query;
    if (!text.trim()) return;
    setSubmitted(text);
    const res = processQuery(text);
    if (res.isComplex) {
      setAgentRunning(true);
      setAgentDone(false);
      setSearchResult(null);
      setShowCompare(false);
    } else {
      setSearchResult(res);
      setAgentRunning(false);
      if (res.results.some(r => r.type === "suppliers" && r.data.length >= 2)) setShowCompare(true);
    }
  };

  const handleAgentComplete = () => {
    setAgentRunning(false);
    setAgentDone(true);
    const res = processQuery(submitted);
    setSearchResult(res);
    setShowCompare(true);
  };

  const handleNavigate = (b) => {
    if (b.tab === "impact") onNavigate("impact");
    else if (b.tab === "hopper") onNavigate("hopper", b.oppId);
  };

  const ResultsSection = () => {
    if (!searchResult) return null;
    return (
      <div className="fade-in">
        <div style={{ marginBottom:12 }}>
          <div style={{ fontSize:12, color:C.gray, marginBottom:6, fontWeight:500 }}>Data sources consulted</div>
          <DataSourceViz sources={searchResult.sources} />
        </div>
        {searchResult.results.map((r, i) => (
          <div key={i} className="fade-in" style={{ animationDelay:`${i*80}ms` }}>
            {r.type === "suppliers" && (
              <div style={{ marginBottom:16 }}>
                {showCompare && r.data.length >= 2 && (
                  <div style={{ marginBottom:12 }}>
                    <SupplierCompare suppliers={r.data} />
                  </div>
                )}
                {r.data.map(s => (
                  <div key={s.id} style={{ ...card, marginBottom:10 }}>
                    <div style={{ display:"flex", justifyContent:"space-between", alignItems:"flex-start", marginBottom:12 }}>
                      <div>
                        <div style={{ fontWeight:700, fontSize:14, color:C.dark }}>{s.name}</div>
                        <div style={{ fontSize:12, color:C.gray, marginTop:2 }}>{s.category} · {s.location}</div>
                      </div>
                      <div style={{ display:"flex", gap:6 }}>
                        {s.incumbent && <span style={{ ...badge(C.indigo, C.indigoBg) }}>Incumbent</span>}
                        <span style={{ ...badge(s.risk==="Low" ? C.green : s.risk==="High" ? C.red : C.amber, s.risk==="Low" ? C.greenBg : s.risk==="High" ? C.redBg : C.amberBg) }}>{s.risk} Risk</span>
                      </div>
                    </div>
                    <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr 1fr", gap:10, marginBottom:12 }}>
                      {[["Quality", s.quality, C.green], ["Delivery", s.delivery, C.indigo], ["Cost", s.cost, C.amber]].map(([l,v,c]) => (
                        <div key={l}>
                          <div style={{ fontSize:11, color:C.gray, marginBottom:4 }}>{l}</div>
                          <ScoreBar value={v} color={c} />
                        </div>
                      ))}
                    </div>
                    <div style={{ fontSize:12, color:C.gray }}>Annual Spend: <strong style={{ color:C.dark }}>{fmt(s.spend)}</strong> · Defect Rate: <strong style={{ color: s.defectRate > 2 ? C.red : C.dark }}>{s.defectRate}%</strong></div>
                  </div>
                ))}
              </div>
            )}
            {r.type === "warranty" && (
              <div style={{ ...card, marginBottom:16 }}>
                <div style={{ fontSize:13, fontWeight:700, color:C.dark, marginBottom:12 }}>Warranty Spend Analysis</div>
                <table style={{ width:"100%", borderCollapse:"collapse", fontSize:13 }}>
                  <thead>
                    <tr>{["SKU","Name","Supplier","Warranty Spend","Defect Rate"].map(h=><th key={h} style={{ textAlign:"left",padding:"8px 10px",fontWeight:600,color:C.gray,borderBottom:`1px solid ${C.border}`,fontSize:11 }}>{h}</th>)}</tr>
                  </thead>
                  <tbody>
                    {r.data.map((sku,i) => (
                      <tr key={sku.id} className="fade-in" style={{ animationDelay:`${i*50}ms` }}>
                        <td style={{ padding:"8px 10px",color:C.gray,fontSize:12,borderBottom:`1px solid ${C.border}` }}>{sku.id}</td>
                        <td style={{ padding:"8px 10px",fontWeight:500,color:C.dark,borderBottom:`1px solid ${C.border}` }}>{sku.name}</td>
                        <td style={{ padding:"8px 10px",color:C.mid,borderBottom:`1px solid ${C.border}` }}>{sku.supplier}</td>
                        <td style={{ padding:"8px 10px",color:C.red,fontWeight:600,borderBottom:`1px solid ${C.border}` }}>{fmt(sku.warrantySpend)}</td>
                        <td style={{ padding:"8px 10px",borderBottom:`1px solid ${C.border}` }}><span style={{ ...badge(sku.defectRate>2?C.red:C.amber, sku.defectRate>2?C.redBg:C.amberBg) }}>{sku.defectRate}%</span></td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
            {r.type === "contracts" && (
              <div style={{ ...card, marginBottom:16 }}>
                <div style={{ fontSize:13, fontWeight:700, color:C.dark, marginBottom:12 }}>Upcoming Contract Renewals</div>
                {r.data.map(opp => (
                  <div key={opp.id} style={{ display:"flex", justifyContent:"space-between", alignItems:"center", padding:"10px 0", borderBottom:`1px solid ${C.border}` }}>
                    <div>
                      <div style={{ fontSize:13, fontWeight:600, color:C.dark }}>{opp.title}</div>
                      <div style={{ fontSize:12, color:C.gray, marginTop:2 }}>{opp.description.slice(0,60)}...</div>
                    </div>
                    <span style={{ ...badge(C.red, C.redBg), marginLeft:12 }}>{fmt(opp.impact)} at risk</span>
                  </div>
                ))}
              </div>
            )}
            {r.type === "risks" && (
              <div style={{ ...card, marginBottom:16 }}>
                <div style={{ fontSize:13, fontWeight:700, color:C.dark, marginBottom:12 }}>Supply Chain Risks</div>
                {r.data.map(opp => (
                  <div key={opp.id} style={{ display:"flex", justifyContent:"space-between", alignItems:"center", padding:"10px 0", borderBottom:`1px solid ${C.border}` }}>
                    <div>
                      <div style={{ fontSize:13, fontWeight:600, color:C.dark }}>{opp.title}</div>
                      <div style={{ fontSize:12, color:C.gray, marginTop:2 }}>{opp.description.slice(0,60)}...</div>
                    </div>
                    <span style={{ ...badge(C.red, C.redBg), marginLeft:12 }}>High</span>
                  </div>
                ))}
              </div>
            )}
            {r.type === "opportunities" && (
              <div style={{ ...card, marginBottom:16 }}>
                <div style={{ fontSize:13, fontWeight:700, color:C.dark, marginBottom:12 }}>Opportunities</div>
                {r.data.map(opp => (
                  <div key={opp.id} style={{ display:"flex", justifyContent:"space-between", alignItems:"center", padding:"10px 0", borderBottom:`1px solid ${C.border}` }}>
                    <div>
                      <div style={{ fontSize:13, fontWeight:600, color:C.dark }}>{opp.title}</div>
                      <span style={{ ...badge(C.indigo, C.indigoBg), marginTop:4, display:"inline-block" }}>{opp.classification}</span>
                    </div>
                    <span style={{ ...badge(C.green, C.greenBg), marginLeft:12 }}>{fmt(opp.impact)}</span>
                  </div>
                ))}
              </div>
            )}
          </div>
        ))}
      </div>
    );
  };

  return (
    <div style={{ maxWidth:860, margin:"0 auto", padding:"32px 20px" }}>
      {/* Logo */}
      <div style={{ display:"flex", alignItems:"center", gap:10, marginBottom:32 }}>
        <div style={{ width:36, height:36, borderRadius:10, background:C.indigo, display:"flex", alignItems:"center", justifyContent:"center" }}>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        </div>
        <div>
          <span style={{ fontSize:16, fontWeight:800, color:C.dark }}>Glean</span>
          <span style={{ fontSize:16, fontWeight:400, color:C.gray }}> Procurement Intelligence</span>
        </div>
      </div>

      {/* Search */}
      <div style={{ position:"relative", marginBottom:16 }}>
        <div style={{ position:"absolute", left:14, top:"50%", transform:"translateY(-50%)" }}>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke={C.gray} strokeWidth="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        </div>
        <input
          value={query}
          onChange={e => setQuery(e.target.value)}
          onKeyDown={e => e.key === "Enter" && handleSearch()}
          placeholder="Ask anything about your suppliers, spend, contracts, or risks..."
          style={{ width:"100%", padding:"14px 16px 14px 44px", paddingRight: submitted ? "110px" : "90px", fontSize:15, border:`2px solid ${submitted ? C.indigo : C.border}`, borderRadius:12, outline:"none", background:C.white, fontFamily:"DM Sans", color:C.dark }}
        />
        {submitted && (
          <button onClick={() => { setQuery(""); setSubmitted(""); setSearchResult(null); setAgentRunning(false); setAgentDone(false); setShowCompare(false); }} style={{ position:"absolute", right:90, top:"50%", transform:"translateY(-50%)", background:"none", border:"none", cursor:"pointer", color:C.gray, display:"flex", alignItems:"center", justifyContent:"center", width:28, height:28, borderRadius:"50%", fontSize:18, lineHeight:1 }}
            title="Clear search">✕</button>
        )}
        <button onClick={() => handleSearch()} style={{ position:"absolute", right:10, top:"50%", transform:"translateY(-50%)", background:C.indigo, color:C.white, border:"none", borderRadius:8, padding:"8px 18px", fontSize:13, fontWeight:600, cursor:"pointer" }}>Search</button>
      </div>

      {!submitted && (
        <div style={{ display:"flex", flexDirection:"column", gap:8, marginBottom:24 }}>
          <div style={{ display:"flex", flexWrap:"wrap", gap:8 }}>
            {SUGGESTIONS_ROW1.map(s => (
              <button key={s} onClick={() => { setQuery(s); handleSearch(s); }} style={{ background:C.indigoBg, border:`1px solid ${C.indigo}40`, borderRadius:20, padding:"6px 14px", fontSize:12, color:C.indigo, fontWeight:500, cursor:"pointer", fontFamily:"DM Sans" }}>{s}</button>
            ))}
          </div>
          <div style={{ display:"flex", flexWrap:"wrap", gap:8 }}>
            {SUGGESTIONS_ROW2.map(s => (
              <button key={s} onClick={() => { setQuery(s); handleSearch(s); }} style={{ background:C.white, border:`1px solid ${C.border}`, borderRadius:20, padding:"6px 14px", fontSize:12, color:C.mid, cursor:"pointer", fontFamily:"DM Sans" }}>{s}</button>
            ))}
          </div>
        </div>
      )}

      {/* Morning Briefing — shown below search when no query submitted */}
      {!submitted && <MorningBriefing onNavigate={handleNavigate} />}

      {submitted && (
        <div style={{ fontSize:13, color:C.gray, marginBottom:16 }}>
          Results for: <strong style={{ color:C.dark }}>"{submitted}"</strong>
        </div>
      )}

      {agentRunning && <AgentThinking onComplete={handleAgentComplete} />}
      {(agentDone || (!agentRunning && searchResult)) && <ResultsSection />}
    </div>
  );
};

// ─── OPPORTUNITY HOPPER ───────────────────────────────────────────────────────

const EmailModal = ({ opp, onClose }) => {
  const [copied, setCopied] = React.useState(false);
  const emailBody = `Subject: Cost Reduction Discussion – ${opp.commodity} Commodity Pricing

Dear ThermoFlow Supplier Relations Team,

I'm reaching out regarding a pricing review for SKU-4421 (Cabin HVAC Module) based on recent commodity market movements.

Market data indicates ${opp.commodity} has declined ${Math.round((1-opp.currentPrice/opp.price6m)*100)}% over the past six months (from $${opp.price6m}/lb to $${opp.currentPrice}/lb). Given that copper is the primary cost driver in your bill of materials, we believe an adjustment to current pricing is warranted.

Current state:
• Contract unit price: $${opp.currentMaterialCost} material cost component
• Market benchmark: $${opp.benchmarkCost} based on current LME pricing
• Estimated savings opportunity: $${opp.unitSavings}/unit · ${fmt(opp.impact)} annualized

We'd like to schedule a review to discuss aligning pricing to current market conditions. We value our partnership with ThermoFlow and see this as an opportunity to strengthen our commercial relationship.

Please confirm availability for a call this week.

Best regards,
Procurement Team`;

  const copy = () => { navigator.clipboard.writeText(emailBody).then(() => { setCopied(true); setTimeout(() => setCopied(false), 2000); }); };

  return (
    <div style={{ position:"fixed", inset:0, background:"rgba(0,0,0,0.5)", display:"flex", alignItems:"center", justifyContent:"center", zIndex:1000 }} onClick={onClose}>
      <div style={{ background:C.white, borderRadius:16, padding:24, maxWidth:620, width:"90%", maxHeight:"80vh", overflow:"auto" }} onClick={e=>e.stopPropagation()}>
        <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:16 }}>
          <div style={{ fontSize:15, fontWeight:700, color:C.dark }}>Supplier Negotiation Email</div>
          <button onClick={onClose} style={{ background:"none", border:"none", fontSize:18, cursor:"pointer", color:C.gray }}>×</button>
        </div>
        <div style={{ background:C.bg, borderRadius:10, padding:16, fontFamily:"monospace", fontSize:12, whiteSpace:"pre-wrap", lineHeight:1.6, color:C.dark, marginBottom:16 }}>{emailBody}</div>
        <div style={{ display:"flex", gap:10 }}>
          <button onClick={copy} style={{ flex:1, background:C.indigo, color:C.white, border:"none", borderRadius:8, padding:"10px 0", fontSize:13, fontWeight:600, cursor:"pointer" }}>{copied ? "✓ Copied!" : "Copy to Clipboard"}</button>
          <button onClick={onClose} style={{ padding:"10px 20px", background:"none", border:`1px solid ${C.border}`, borderRadius:8, fontSize:13, cursor:"pointer", color:C.gray }}>Close</button>
        </div>
      </div>
    </div>
  );
};

const CommodityDetail = ({ opp, onBack, statusChanger }) => {
  const [emailOpen, setEmailOpen] = React.useState(false);
  return (
    <div className="fade-in">
      {emailOpen && <EmailModal opp={opp} onClose={() => setEmailOpen(false)} />}
      <button onClick={onBack} style={{ background:"none", border:"none", color:C.indigo, fontSize:13, fontWeight:600, cursor:"pointer", marginBottom:16, display:"flex", alignItems:"center", gap:6 }}>← Back to Hopper</button>
      <div style={{ fontSize:16, fontWeight:800, color:C.dark, marginBottom:4 }}>{opp.title}</div>
      <div style={{ fontSize:13, color:C.gray, marginBottom:20 }}>{opp.description}</div>

      {/* Price Movement */}
      <div style={{ display:"grid", gridTemplateColumns:"repeat(3,1fr)", gap:12, marginBottom:16 }}>
        {[["6 Months Ago", `$${opp.price6m}`, C.gray], ["3 Months Ago", `$${opp.price3m}`, C.amber], ["Current", `$${opp.currentPrice}`, C.green]].map(([l,v,c]) => (
          <div key={l} style={{ ...smallCard, textAlign:"center", borderTop:`3px solid ${c}` }}>
            <div style={{ fontSize:11, color:C.gray, marginBottom:6 }}>{l}</div>
            <div style={{ fontSize:22, fontWeight:800, color:c }}>{v}</div>
            <div style={{ fontSize:11, color:C.gray }}>{opp.commodity} / lb</div>
          </div>
        ))}
      </div>

      {/* Impact */}
      <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:12, marginBottom:16 }}>
        <div style={{ ...card }}>
          <div style={{ fontSize:12, fontWeight:700, color:C.dark, marginBottom:12 }}>Unit Price Impact</div>
          {[["Current material cost", `$${opp.currentMaterialCost}`, C.dark], ["Market benchmark", `$${opp.benchmarkCost}`, C.green], ["Potential savings/unit", `$${opp.unitSavings}`, C.indigo]].map(([l,v,c]) => (
            <div key={l} style={{ display:"flex", justifyContent:"space-between", padding:"6px 0", borderBottom:`1px solid ${C.border}` }}>
              <span style={{ fontSize:12, color:C.gray }}>{l}</span>
              <span style={{ fontSize:13, fontWeight:700, color:c }}>{v}</span>
            </div>
          ))}
        </div>
        <div style={{ ...card }}>
          <div style={{ fontSize:12, fontWeight:700, color:C.dark, marginBottom:12 }}>Total Cost of Ownership</div>
          {[["Unit Price", opp.tcoBreakdown.unitPrice], ["Quality Cost", opp.tcoBreakdown.quality], ["Logistics", opp.tcoBreakdown.logistics], ["Inventory", opp.tcoBreakdown.inventory], ["Admin", opp.tcoBreakdown.admin]].map(([l,v]) => (
            <div key={l} style={{ display:"flex", justifyContent:"space-between", padding:"4px 0", borderBottom:`1px solid ${C.border}` }}>
              <span style={{ fontSize:12, color:C.gray }}>{l}</span>
              <span style={{ fontSize:12, fontWeight:500, color:C.dark }}>${v}</span>
            </div>
          ))}
          <div style={{ display:"flex", justifyContent:"space-between", padding:"8px 0 4px" }}>
            <span style={{ fontSize:12, fontWeight:700, color:C.dark }}>Total TCO</span>
            <span style={{ fontSize:13, fontWeight:800, color:C.red }}>${opp.tcoBreakdown.total} <span style={{ fontSize:11, color:C.gray }}>vs ${opp.tcoBreakdown.benchmark} benchmark</span></span>
          </div>
        </div>
      </div>

      {/* Affected Parts */}
      <div style={{ ...card, marginBottom:16 }}>
        <div style={{ fontSize:12, fontWeight:700, color:C.dark, marginBottom:10 }}>Affected Parts</div>
        {opp.parts.map(partId => {
          const sku = skus.find(s => s.id === partId);
          if (!sku) return null;
          return (
            <div key={partId} style={{ display:"flex", justifyContent:"space-between", padding:"8px 0", borderBottom:`1px solid ${C.border}` }}>
              <div>
                <span style={{ fontSize:12, fontWeight:600, color:C.dark }}>{sku.id}</span>
                <span style={{ fontSize:12, color:C.gray, marginLeft:8 }}>{sku.name}</span>
              </div>
              <div style={{ fontSize:12, color:C.gray }}>{sku.volume.toLocaleString()} units/yr · {fmt(sku.annualSpend)}</div>
            </div>
          );
        })}
      </div>

      {/* Actions */}
      <div style={{ display:"flex", gap:10 }}>
        <button onClick={() => setEmailOpen(true)} style={{ background:C.indigo, color:C.white, border:"none", borderRadius:10, padding:"12px 24px", fontSize:13, fontWeight:700, cursor:"pointer" }}>Draft Email</button>
        <button disabled style={{ background:C.bg, color:C.gray, border:`1px solid ${C.border}`, borderRadius:10, padding:"12px 24px", fontSize:13, fontWeight:600, cursor:"not-allowed" }}>Launch RFP <span style={{ fontSize:11 }}>· Coming soon</span></button>
        <button disabled style={{ background:C.bg, color:C.gray, border:`1px solid ${C.border}`, borderRadius:10, padding:"12px 24px", fontSize:13, fontWeight:600, cursor:"not-allowed" }}>Add to Backlog <span style={{ fontSize:11 }}>· Coming soon</span></button>
      </div>
      {statusChanger}
    </div>
  );
};

const OpportunityDetail = ({ opp, onBack, statusChanger }) => (
  <div className="fade-in">
    <button onClick={onBack} style={{ background:"none", border:"none", color:C.indigo, fontSize:13, fontWeight:600, cursor:"pointer", marginBottom:16 }}>← Back to Hopper</button>
    <div style={{ fontSize:16, fontWeight:800, color:C.dark, marginBottom:4 }}>{opp.title}</div>
    <div style={{ marginBottom:8, display:"flex", gap:8 }}>
      <span style={{ ...badge(C.indigo, C.indigoBg) }}>{opp.classification}</span>
      <span style={{ ...badge(opp.urgency==="High"?C.red:C.amber, opp.urgency==="High"?C.redBg:C.amberBg) }}>{opp.urgency} Urgency</span>
    </div>
    <div style={{ ...card, marginBottom:16 }}>
      <div style={{ fontSize:13, color:C.mid, lineHeight:1.6 }}>{opp.description}</div>
      <div style={{ marginTop:12, padding:"12px 0 0", borderTop:`1px solid ${C.border}`, display:"flex", gap:24 }}>
        <div><div style={{ fontSize:11, color:C.gray }}>Estimated Impact</div><div style={{ fontSize:18, fontWeight:800, color:C.green }}>{fmt(opp.impact)}</div></div>
        <div><div style={{ fontSize:11, color:C.gray }}>Status</div><div style={{ fontSize:14, fontWeight:600, color:C.dark }}>{opp.status}</div></div>
      </div>
      {statusChanger}
    </div>
    <div style={{ ...card }}>
      <div style={{ fontSize:12, fontWeight:700, color:C.dark, marginBottom:10 }}>Affected Parts</div>
      {opp.parts.map(partId => { const sku = skus.find(s=>s.id===partId); if(!sku) return null; return (
        <div key={partId} style={{ display:"flex", justifyContent:"space-between", padding:"8px 0", borderBottom:`1px solid ${C.border}` }}>
          <span style={{ fontSize:12, color:C.dark, fontWeight:500 }}>{sku.id} · {sku.name}</span>
          <span style={{ fontSize:12, color:C.gray }}>{fmt(sku.annualSpend)}/yr</span>
        </div>
      ); })}
    </div>
  </div>
);

const OpportunityHopper = ({ initialOppId }) => {
  const [filterClass, setFilterClass] = React.useState("All");
  const [filterStatus, setFilterStatus] = React.useState("All");
  const [selected, setSelected] = React.useState(null);
  const [oppStatuses, setOppStatuses] = React.useState(() => {
    const map = {};
    opportunities.forEach(o => {
      // Normalize legacy statuses to new set
      const norm = { "Investigating": "In Progress", "Under progress": "In Progress" };
      map[o.id] = norm[o.status] || o.status === "Viewed" ? (norm[o.status] || o.status) : "New";
    });
    return map;
  });

  React.useEffect(() => {
    if (initialOppId) {
      const opp = opportunities.find(o => o.id === initialOppId);
      if (opp) setSelected({ ...opp, status: oppStatuses[opp.id] });
    }
  }, [initialOppId]);

  const updateStatus = (id, status) => {
    setOppStatuses(prev => ({ ...prev, [id]: status }));
    if (selected && selected.id === id) setSelected(prev => ({ ...prev, status }));
  };

  const classes = ["All", "Commodity Changes", "Contract Renewals", "Supply Chain Risks", "VAVE"];
  const statuses = ["All", "New", "Viewed", "In Progress", "Completed"];

  const getOpp = (o) => ({ ...o, status: oppStatuses[o.id] || o.status });

  const filtered = opportunities
    .map(getOpp)
    .filter(o =>
      (filterClass === "All" || o.classification === filterClass) &&
      (filterStatus === "All" || o.status === filterStatus)
    );

  const totalPipeline = opportunities.reduce((a, b) => a + b.impact, 0);
  const classCount = (c) => opportunities.filter(o => o.classification === c).reduce((a,b) => a+b.impact, 0);

  const statusColors = { New: C.indigo, Viewed: C.gray, "In Progress": C.amber, Completed: C.green };
  const statusBgs = { New: C.indigoBg, Viewed: C.bg, "In Progress": C.amberBg, Completed: C.greenBg };

  const StatusChanger = ({ opp }) => (
    <div style={{ display:"flex", alignItems:"center", gap:8, marginTop:16, padding:"12px 0 0", borderTop:`1px solid ${C.border}` }}>
      <span style={{ fontSize:12, color:C.gray, fontWeight:500 }}>Update status:</span>
      <div style={{ display:"flex", gap:6 }}>
        {["In Progress", "Completed"].map(s => (
          <button key={s} onClick={() => updateStatus(opp.id, s)} style={{ padding:"5px 14px", borderRadius:20, border:`1px solid ${opp.status===s ? statusColors[s] : C.border}`, background: opp.status===s ? statusColors[s] : C.white, color: opp.status===s ? C.white : C.gray, fontSize:12, fontWeight:600, cursor:"pointer", transition:"all 0.2s" }}>{s}</button>
        ))}
      </div>
      <span style={{ marginLeft:"auto", ...badge(statusColors[opp.status] || C.gray, statusBgs[opp.status] || C.bg) }}>Current: {opp.status}</span>
    </div>
  );

  if (selected) {
    const liveOpp = { ...selected, status: oppStatuses[selected.id] };
    return (
      <div>
        {selected.classification === "Commodity Changes"
          ? <CommodityDetail opp={liveOpp} onBack={() => setSelected(null)} statusChanger={<StatusChanger opp={liveOpp} />} />
          : <OpportunityDetail opp={liveOpp} onBack={() => setSelected(null)} statusChanger={<StatusChanger opp={liveOpp} />} />
        }
      </div>
    );
  }

  return (
    <div className="fade-in">
      {/* Summary Cards */}
      <div style={{ display:"grid", gridTemplateColumns:"repeat(4,1fr)", gap:12, marginBottom:20 }}>
        {[
          { label:"Total Pipeline", value:fmt(totalPipeline), color:C.indigo },
          { label:"Commodity Changes", value:fmt(classCount("Commodity Changes")), color:"#7C3AED" },
          { label:"Supply Chain Risks", value:fmt(classCount("Supply Chain Risks")), color:C.red },
          { label:"Contract Renewals", value:fmt(classCount("Contract Renewals")), color:C.amber },
        ].map(m => (
          <div key={m.label} style={{ ...smallCard, borderTop:`3px solid ${m.color}` }}>
            <div style={{ fontSize:11, color:C.gray, marginBottom:6 }}>{m.label}</div>
            <div style={{ fontSize:20, fontWeight:800, color:m.color }}>{m.value}</div>
          </div>
        ))}
      </div>

      {/* Filters — Classification row, then Status row */}
      <div style={{ display:"flex", flexDirection:"column", gap:8, marginBottom:16 }}>
        <div style={{ display:"flex", gap:4, background:C.bg, borderRadius:10, padding:4, alignSelf:"flex-start" }}>
          {classes.map(c => <button key={c} onClick={() => setFilterClass(c)} style={{ padding:"5px 12px", borderRadius:8, border:"none", fontSize:12, fontWeight:500, cursor:"pointer", background: filterClass===c ? C.indigo : "transparent", color: filterClass===c ? C.white : C.gray, transition:"all 0.2s" }}>{c}</button>)}
        </div>
        <div style={{ display:"flex", gap:4, background:C.bg, borderRadius:10, padding:4, alignSelf:"flex-start" }}>
          {statuses.map(s => <button key={s} onClick={() => setFilterStatus(s)} style={{ padding:"5px 12px", borderRadius:8, border:"none", fontSize:12, fontWeight:500, cursor:"pointer", background: filterStatus===s ? (statusColors[s] || C.indigo) : "transparent", color: filterStatus===s ? C.white : C.gray, transition:"all 0.2s" }}>{s}</button>)}
        </div>
      </div>

      {/* List */}
      <div style={{ display:"flex", flexDirection:"column", gap:8 }}>
        {filtered.map((opp, i) => (
          <div key={opp.id} onClick={() => setSelected(opp)} className="fade-in" style={{ animationDelay:`${i*40}ms`, ...card, cursor:"pointer", transition:"box-shadow 0.2s" }}
            onMouseEnter={e => e.currentTarget.style.boxShadow="0 4px 20px rgba(0,0,0,0.08)"}
            onMouseLeave={e => e.currentTarget.style.boxShadow="none"}>
            <div style={{ display:"flex", justifyContent:"space-between", alignItems:"flex-start" }}>
              <div style={{ flex:1 }}>
                {/* Classification row */}
                <div style={{ display:"flex", alignItems:"center", gap:8, marginBottom:4 }}>
                  <span style={{ ...badge(C.indigo, C.indigoBg) }}>{opp.classification}</span>
                  <span style={{ ...badge(opp.urgency==="High"?C.red:opp.urgency==="Medium"?C.amber:C.green, opp.urgency==="High"?C.redBg:opp.urgency==="Medium"?C.amberBg:C.greenBg) }}>{opp.urgency}</span>
                </div>
                {/* Status row */}
                <div style={{ marginBottom:8 }}>
                  <span style={{ ...badge(statusColors[opp.status] || C.gray, statusBgs[opp.status] || C.bg) }}>{opp.status}</span>
                </div>
                <div style={{ fontSize:14, fontWeight:600, color:C.dark, marginBottom:4 }}>{opp.title}</div>
                <div style={{ fontSize:12, color:C.gray }}>{opp.description.slice(0,80)}...</div>
              </div>
              <div style={{ textAlign:"right", marginLeft:16 }}>
                <div style={{ fontSize:18, fontWeight:800, color:C.green }}>{fmt(opp.impact)}</div>
                <div style={{ fontSize:11, color:C.gray }}>estimated impact</div>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

// ─── COST MANAGEMENT ─────────────────────────────────────────────────────────

const CostManagement = () => {
  const [search, setSearch] = React.useState("");
  const [selected, setSelected] = React.useState(null);

  const filtered = costModels.filter(m =>
    m.id.toLowerCase().includes(search.toLowerCase()) ||
    m.name.toLowerCase().includes(search.toLowerCase()) ||
    m.supplier.toLowerCase().includes(search.toLowerCase())
  );

  if (selected) {
    const model = costModels.find(m => m.id === selected);
    const annualSavings = (model.currentCost - model.zbbTarget) * model.annualVolume;
    return (
      <div className="fade-in">
        <button onClick={() => setSelected(null)} style={{ background:"none", border:"none", color:C.indigo, fontSize:13, fontWeight:600, cursor:"pointer", marginBottom:16 }}>← Back</button>
        <div style={{ fontSize:16, fontWeight:800, color:C.dark, marginBottom:4 }}>{model.name}</div>
        <div style={{ fontSize:13, color:C.gray, marginBottom:20 }}>{model.id} · {model.supplier}</div>

        <div style={{ display:"grid", gridTemplateColumns:"repeat(3,1fr)", gap:12, marginBottom:16 }}>
          {[["Current Cost", `$${model.currentCost}`, C.red], ["ZBB Target", `$${model.zbbTarget}`, C.green], ["Annual Savings", fmt(annualSavings), C.indigo]].map(([l,v,c]) => (
            <div key={l} style={{ ...smallCard, textAlign:"center", borderTop:`3px solid ${c}` }}>
              <div style={{ fontSize:11, color:C.gray, marginBottom:6 }}>{l}</div>
              <div style={{ fontSize:22, fontWeight:800, color:c }}>{v}</div>
            </div>
          ))}
        </div>

        <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:16 }}>
          <div style={{ ...card }}>
            <div style={{ fontSize:13, fontWeight:700, color:C.dark, marginBottom:12 }}>Zero-Based Cost Breakdown</div>
            {Object.entries(model.breakdown).map(([section, data]) => (
              <div key={section} style={{ marginBottom:10 }}>
                <div style={{ fontSize:11, color:C.gray, textTransform:"uppercase", letterSpacing:"0.5px", marginBottom:6 }}>{section.replace(/([A-Z])/g," $1").trim()}</div>
                {typeof data === "object" && !data.cost ? (
                  Object.entries(data).map(([k, v]) => (
                    <div key={k} style={{ display:"flex", justifyContent:"space-between", padding:"4px 0", borderBottom:`1px solid ${C.border}` }}>
                      <span style={{ fontSize:12, color:C.mid, textTransform:"capitalize" }}>{k}</span>
                      <span style={{ display:"flex", gap:12 }}>
                        <span style={{ fontSize:12, fontWeight:600, color:C.red }}>${v.cost}</span>
                        <span style={{ fontSize:12, color:C.green }}>→ ${v.benchmark}</span>
                      </span>
                    </div>
                  ))
                ) : (
                  <div style={{ display:"flex", justifyContent:"space-between", padding:"4px 0", borderBottom:`1px solid ${C.border}` }}>
                    <span style={{ fontSize:12, color:C.mid }}>{section}</span>
                    <span style={{ display:"flex", gap:12 }}>
                      <span style={{ fontSize:12, fontWeight:600, color:C.red }}>${data.cost}</span>
                      <span style={{ fontSize:12, color:C.green }}>→ ${data.benchmark}</span>
                    </span>
                  </div>
                )}
              </div>
            ))}
          </div>
          <div style={{ ...card }}>
            <div style={{ fontSize:13, fontWeight:700, color:C.dark, marginBottom:12 }}>Total Cost of Ownership</div>
            {[["Unit Price", model.tco.unitPrice], ["Quality Cost", model.tco.quality], ["Logistics", model.tco.logistics], ["Inventory Carrying", model.tco.inventory], ["Admin / Mgmt", model.tco.admin], ...(model.tco.tariff > 0 ? [["Tariff Exposure", model.tco.tariff]] : [])].map(([l,v]) => (
              <div key={l} style={{ display:"flex", justifyContent:"space-between", padding:"6px 0", borderBottom:`1px solid ${C.border}` }}>
                <span style={{ fontSize:12, color:C.gray }}>{l}</span>
                <span style={{ fontSize:12, fontWeight:600, color: l.includes("Tariff") ? C.red : C.dark }}>${v}</span>
              </div>
            ))}
            <div style={{ display:"flex", justifyContent:"space-between", padding:"10px 0 4px", marginTop:4 }}>
              <span style={{ fontSize:13, fontWeight:700, color:C.dark }}>Total TCO</span>
              <div style={{ textAlign:"right" }}>
                <div style={{ fontSize:16, fontWeight:800, color:C.red }}>${model.tco.total}</div>
                <div style={{ fontSize:11, color:C.gray }}>Benchmark: ${model.tco.benchmark} · Gap: {pct(model.tco.total, model.tco.benchmark)}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="fade-in">
      <div style={{ fontSize:18, fontWeight:800, color:C.dark, marginBottom:4 }}>Cost Management</div>
      <div style={{ fontSize:13, color:C.gray, marginBottom:20 }}>Zero-based costing and TCO analysis for your key components</div>
      <input value={search} onChange={e => setSearch(e.target.value)} placeholder="Search by SKU, name, or supplier..." style={{ width:"100%", padding:"10px 14px", border:`1px solid ${C.border}`, borderRadius:10, fontSize:13, fontFamily:"DM Sans", marginBottom:16, outline:"none" }} />
      <div style={{ display:"flex", flexDirection:"column", gap:8 }}>
        {filtered.map((model, i) => {
          const savings = (model.currentCost - model.zbbTarget) * model.annualVolume;
          return (
            <div key={model.id} onClick={() => setSelected(model.id)} className="fade-in" style={{ animationDelay:`${i*50}ms`, ...card, cursor:"pointer" }}
              onMouseEnter={e => e.currentTarget.style.boxShadow="0 4px 20px rgba(0,0,0,0.08)"}
              onMouseLeave={e => e.currentTarget.style.boxShadow="none"}>
              <div style={{ display:"flex", justifyContent:"space-between", alignItems:"flex-start" }}>
                <div>
                  <div style={{ fontSize:14, fontWeight:700, color:C.dark }}>{model.name}</div>
                  <div style={{ fontSize:12, color:C.gray, marginTop:2 }}>{model.id} · {model.supplier}</div>
                  <div style={{ marginTop:8, display:"flex", gap:12 }}>
                    <span style={{ fontSize:12 }}>Current: <strong style={{ color:C.red }}>${model.currentCost}</strong></span>
                    <span style={{ fontSize:12 }}>ZBB Target: <strong style={{ color:C.green }}>${model.zbbTarget}</strong></span>
                    <span style={{ fontSize:12 }}>Volume: <strong style={{ color:C.dark }}>{model.annualVolume.toLocaleString()}/yr</strong></span>
                  </div>
                </div>
                <div style={{ textAlign:"right" }}>
                  <div style={{ fontSize:18, fontWeight:800, color:C.green }}>{fmt(savings)}</div>
                  <div style={{ fontSize:11, color:C.gray }}>annual opportunity</div>
                </div>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
};

// ─── TRIGGERS ─────────────────────────────────────────────────────────────────

const Triggers = () => {
  const [triggers, setTriggers] = React.useState(defaultTriggers);
  const [showNew, setShowNew] = React.useState(false);
  const [newTrigger, setNewTrigger] = React.useState({ name:"", type:"Market", condition:"", action:"" });

  const toggle = (id) => setTriggers(prev => prev.map(t => t.id===id ? {...t, enabled:!t.enabled} : t));

  const typeColors = { Market: C.indigo, Contract: C.amber, Risk: C.red, Regulatory: "#7C3AED", Quality: C.green, Engineering: "#0891B2" };

  return (
    <div className="fade-in">
      <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:20 }}>
        <div>
          <div style={{ fontSize:18, fontWeight:800, color:C.dark }}>Triggers</div>
          <div style={{ fontSize:13, color:C.gray, marginTop:2 }}>Automated signals that surface intelligence proactively</div>
        </div>
        <button onClick={() => setShowNew(!showNew)} style={{ background:C.indigo, color:C.white, border:"none", borderRadius:10, padding:"10px 18px", fontSize:13, fontWeight:600, cursor:"pointer" }}>+ New Trigger</button>
      </div>

      {showNew && (
        <div style={{ ...card, marginBottom:20, borderLeft:`3px solid ${C.indigo}` }}>
          <div style={{ fontSize:13, fontWeight:700, color:C.dark, marginBottom:14 }}>Create New Trigger</div>
          <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:12, marginBottom:12 }}>
            {[["Trigger Name", "name", "text"], ["Condition", "condition", "text"], ["Action", "action", "text"]].map(([l,k,t]) => (
              <div key={k} style={k==="condition"||k==="action" ? { gridColumn:"span 2" } : {}}>
                <div style={{ fontSize:11, color:C.gray, marginBottom:4, fontWeight:500 }}>{l}</div>
                <input value={newTrigger[k]} onChange={e => setNewTrigger({...newTrigger, [k]: e.target.value})} style={{ width:"100%", padding:"8px 12px", border:`1px solid ${C.border}`, borderRadius:8, fontSize:12, fontFamily:"DM Sans", outline:"none" }} />
              </div>
            ))}
          </div>
          <div style={{ display:"flex", gap:10 }}>
            <button onClick={() => { setTriggers([...triggers, {...newTrigger, id:Date.now(), enabled:true, lastTriggered:"Never", count:0}]); setShowNew(false); setNewTrigger({name:"",type:"Market",condition:"",action:""}); }} style={{ background:C.indigo, color:C.white, border:"none", borderRadius:8, padding:"8px 18px", fontSize:12, fontWeight:600, cursor:"pointer" }}>Create Trigger</button>
            <button onClick={() => setShowNew(false)} style={{ background:"none", border:`1px solid ${C.border}`, borderRadius:8, padding:"8px 18px", fontSize:12, cursor:"pointer", color:C.gray }}>Cancel</button>
          </div>
        </div>
      )}

      <div style={{ display:"flex", flexDirection:"column", gap:8 }}>
        {triggers.map((t, i) => (
          <div key={t.id} className="fade-in" style={{ animationDelay:`${i*40}ms`, ...card, opacity: t.enabled ? 1 : 0.6 }}>
            <div style={{ display:"flex", justifyContent:"space-between", alignItems:"flex-start" }}>
              <div style={{ flex:1 }}>
                <div style={{ display:"flex", alignItems:"center", gap:8, marginBottom:6 }}>
                  <span style={{ ...badge(typeColors[t.type] || C.gray, `${typeColors[t.type]}18` || C.bg) }}>{t.type}</span>
                  <span style={{ fontSize:12, color:C.gray }}>Triggered {t.count}x · Last: {t.lastTriggered}</span>
                </div>
                <div style={{ fontSize:14, fontWeight:600, color:C.dark, marginBottom:4 }}>{t.name}</div>
                <div style={{ fontSize:12, color:C.gray }}>If: {t.condition}</div>
                <div style={{ fontSize:12, color:C.mid, marginTop:2 }}>Then: {t.action}</div>
              </div>
              <div onClick={() => toggle(t.id)} style={{ marginLeft:16, width:44, height:24, borderRadius:12, background: t.enabled ? C.indigo : "#D1D5DB", position:"relative", cursor:"pointer", transition:"background 0.2s" }}>
                <div style={{ position:"absolute", top:3, left: t.enabled ? 22 : 2, width:18, height:18, borderRadius:"50%", background:C.white, transition:"left 0.2s", boxShadow:"0 1px 3px rgba(0,0,0,0.2)" }} />
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

// ─── APP SHELL ────────────────────────────────────────────────────────────────

const App = () => {
  const [view, setView] = React.useState("search"); // "search" | "app"
  const [appTab, setAppTab] = React.useState("hopper");
  const [initialOppId, setInitialOppId] = React.useState(null);

  const navigateTo = (tab, oppId) => {
    setView("app");
    setAppTab(tab);
    setInitialOppId(oppId || null);
  };

  const appTabs = [
    { id:"hopper", label:"Opportunity Hopper" },
    { id:"cost", label:"Cost Management" },
    { id:"triggers", label:"Triggers" },
    { id:"impact", label:"Impact Intelligence" },
  ];

  React.useEffect(() => {
    if (appTab !== "hopper") setInitialOppId(null);
  }, [appTab]);

  return (
    <div style={{ minHeight:"100vh", background:C.bg }}>
      {/* Top Nav */}
      <div style={{ background:C.white, borderBottom:`1px solid ${C.border}`, padding:"0 24px", display:"flex", alignItems:"center", gap:0, height:52, position:"sticky", top:0, zIndex:100 }}>
        <div style={{ display:"flex", alignItems:"center", gap:8, marginRight:32 }}>
          <div style={{ width:28, height:28, borderRadius:8, background:C.indigo, display:"flex", alignItems:"center", justifyContent:"center" }}>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          </div>
          <span style={{ fontSize:13, fontWeight:700, color:C.dark }}>Glean Procurement</span>
        </div>
        <button onClick={() => setView("search")} style={{ padding:"14px 16px", fontSize:13, fontWeight: view==="search" ? 700 : 400, color: view==="search" ? C.indigo : C.gray, background:"none", border:"none", cursor:"pointer", borderBottom: view==="search" ? `2px solid ${C.indigo}` : "2px solid transparent" }}>Search</button>
        <button onClick={() => setView("app")} style={{ padding:"14px 16px", fontSize:13, fontWeight: view==="app" ? 700 : 400, color: view==="app" ? C.indigo : C.gray, background:"none", border:"none", cursor:"pointer", borderBottom: view==="app" ? `2px solid ${C.indigo}` : "2px solid transparent" }}>Procurement App</button>
        <div style={{ marginLeft:"auto", display:"flex", alignItems:"center", gap:8 }}>
          <div style={{ width:30, height:30, borderRadius:"50%", background:C.indigoBg, display:"flex", alignItems:"center", justifyContent:"center", fontSize:12, fontWeight:700, color:C.indigo }}>BP</div>
        </div>
      </div>

      {view === "search" && <SearchPage onNavigate={navigateTo} />}

      {view === "app" && (
        <div style={{ maxWidth:1000, margin:"0 auto", padding:"24px 20px" }}>
          {/* App Tabs */}
          <div style={{ display:"flex", gap:0, marginBottom:24, background:C.white, borderRadius:12, border:`1px solid ${C.border}`, padding:4 }}>
            {appTabs.map(tab => (
              <button key={tab.id} onClick={() => setAppTab(tab.id)} style={{ flex:1, padding:"8px 0", fontSize:13, fontWeight: appTab===tab.id ? 700 : 400, color: appTab===tab.id ? C.indigo : C.gray, background: appTab===tab.id ? C.indigoBg : "transparent", borderRadius:8, border:"none", cursor:"pointer", transition:"all 0.2s" }}>
                {tab.label}
                {tab.id === "impact" && <span style={{ marginLeft:6, ...badge(C.green, C.greenBg), fontSize:10 }}>New</span>}
              </button>
            ))}
          </div>

          {appTab === "hopper" && <OpportunityHopper initialOppId={initialOppId} />}
          {appTab === "cost" && <CostManagement />}
          {appTab === "triggers" && <Triggers />}
          {appTab === "impact" && <ImpactDashboard />}
        </div>
      )}
    </div>
  );
};

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);
</script>
</body>
</html>
